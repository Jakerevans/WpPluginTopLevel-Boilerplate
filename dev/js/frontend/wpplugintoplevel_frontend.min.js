/**
 * JavaScript Admin Functions - wpplugintoplevel-frontend.min.js
 *
 * @author   Jake Evans
 * @category JavaScript
 * @package  Includes/Assets/Js
 * @version  6.0.0
 */

console.log( 'This is the JavaScript Object that holds all PHP Variables for use in the wpplugintoplevel Front-End JavaScript file:' );
console.log( wppluginToplevelPhpVariables );


// All functions wrapped in jQuery(document ).ready()...
jQuery( document ).ready( function( $ ) {
	'use strict';

	/* BEGINNING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// Function for manually adding a new user from the front-end. 
    wppluginToplevelAddNewUser();

    // Function to reveal a new user's password on the frontend during creation. 
    wppluginToplevelSeeNewUserPassword();

    // Function to edit a user's Account Info on the frontend from their dashboard. 
    wppluginToplevelEditUserAccountInfoFromFrontendDashboard();

    // Function to toggle between the tabs on the logged-in user's dashboard.
    wppluginToplevelToggleTabsOnUsersFrontendDashboard();

    // Function to append the save post button to the end of post titles. 
    wppluginToplevelAppendSavePostHtml();

	/* ENDING SECTION TO CALL ALL FUNCTIONS IN FILE... */


    // Function to append the save post button to the end of post titles. 
    function wppluginToplevelAppendSavePostHtml(){
        var bodyclasses = $('body').attr('class');
        if ( -1 !== bodyclasses.indexOf( 'single-post' ) ){
            if ( '1' === wppluginToplevelPhpVariables.IS_USER_LOGGED_IN ) {

                // Get all saved post ids, if any.
                var set_flag = false;
                if ( ( null !== wppluginToplevelPhpVariables.USER_SAVED_POST_IDS ) && ( '' !== wppluginToplevelPhpVariables.USER_SAVED_POST_IDS ) ) {
                    var ids = wppluginToplevelPhpVariables.USER_SAVED_POST_IDS.split( ',' );
                    for (var i = ids.length - 1; i >= 0; i--) {
                        if ( ids[i] == wppluginToplevelPhpVariables.CURRENT_POST_ID ) {
                            // User is logged in, and HAS saved this post
                            $( '.entry-title' ).after('<div class="wpplugin-save-post-button-top-container"><div class="wpplugin-save-post-button-div wpplugin-save-post-button-div-loggedin"><p>You\'ve already saved this post!</p><img src="' + wppluginToplevelPhpVariables.WPPLUGINTOPLEVEL_ROOT_IMG_URL + 'postalreadysaved.png"/></div><div class="wpplugin-spinner"></div><div class="wpplugin-save-post-response"></div></div>');
                            set_flag = true;
                            break;
                        } 
                    }

                    if ( ! set_flag ) {
                         // User is logged in, and has NOT saved this post
                        $( '.entry-title' ).after('<div class="wpplugin-save-post-button-top-container"><div class="wpplugin-save-post-button-div wpplugin-save-post-button-div-loggedin"><p>Save This Post!</p><img src="' + wppluginToplevelPhpVariables.WPPLUGINTOPLEVEL_ROOT_IMG_URL + 'savethispost.png"/></div><div class="wpplugin-spinner"></div><div class="wpplugin-save-post-response"></div></div>');
                    }

                } else {
                    // User is logged in, and has NOT saved ANY posts
                    $( '.entry-title' ).after('<div class="wpplugin-save-post-button-top-container"><div class="wpplugin-save-post-button-div wpplugin-save-post-button-div-loggedin"><p>Save This Post!</p><img src="' + wppluginToplevelPhpVariables.WPPLUGINTOPLEVEL_ROOT_IMG_URL + 'savethispost.png"/></div><div class="wpplugin-spinner"></div><div class="wpplugin-save-post-response"></div></div>');
                }   
            } else {
                // User is NOT logged in at all
                $( '.entry-title' ).after('<div class="wpplugin-save-post-button-top-container"><div class="wpplugin-save-post-button-div wpplugin-save-post-button-div-notloggedin"><a href="' + wppluginToplevelPhpVariables.FRONTEND_USER_DASHBOARD_SHORTCODE_URL + '"><p>Login to Save This Post!</p><img src="' + wppluginToplevelPhpVariables.WPPLUGINTOPLEVEL_ROOT_IMG_URL + 'savethispost.png"/></a></div><div class="wpplugin-spinner"></div><div class="wpplugin-save-post-response"></div></div>')
            }
        }
    }

    function wppluginToplevelCheckPasswordStrength( $pass1, $pass2, $strengthResult, $submitButton, blacklistArray ) {
        var pass1 = $pass1.val();
        var pass2 = $pass2.val();

        // Reset the form & meter
        $strengthResult.css({'opacity':'1'})
        $strengthResult.removeClass( 'short bad good strong' );

        // Extend our blacklist array with those from the inputs & site data
        blacklistArray = blacklistArray.concat( wp.passwordStrength.userInputDisallowedList() )

        // Get the password strength
        var strength = wp.passwordStrength.meter( pass1, blacklistArray, pass2 );

        // Add the strength meter results
        switch ( strength ) {

            case 2:
                $strengthResult.addClass( 'bad' ).html( "Password Strength too low!" );
                break;

            case 3:
                $strengthResult.addClass( 'good' ).html( "Medium Password Strength" );
                break;

            case 4:
                $strengthResult.addClass( 'strong' ).html( "Great Password!" );
                break;

            case 5:
                $strengthResult.addClass( 'short' ).html( "Passwords Don't Match!" );
                break;

            default:
                $strengthResult.addClass( 'short' ).html( "Password Strength too low!" );

        }

        return strength;
    }

    // Function to reveal a new user's password on the frontend during creation. 
    function wppluginToplevelSeeNewUserPassword(){
        $( document ).on( 'click', '#wpplugin-form-section-see-new-user-password', function( event ) {
            var visibility = $(this).attr('data-visibility');
            if ( 'hidden' === visibility ) {
                $( '#wpplugin-user-password, #wpplugin-user-passwordverify' ).attr('type','text');
                $(this).html('Hide Password');
                $(this).attr('data-visibility', 'visible');
            } else {
                $( '#wpplugin-user-password, #wpplugin-user-passwordverify' ).attr('type','password');
                $(this).html('View Password');
                $(this).attr('data-visibility', 'hidden');
            }  
        });
    }


    // Function to edit a user's Account Info on the frontend from their dashboard. 
    function wppluginToplevelEditUserAccountInfoFromFrontendDashboard(){

        $( document ).on( 'click', '#wpplugin-form-section-edit-user-account-info', function( event ) {
            $( '.wpplugin-form-section-fields-indiv-wrapper-actualinput' ).css({'display':'block'});
            $( '.wpplugin-form-section-fields-indiv-wrapper-justtext' ).css({'display':'none'});
            $( '.wpplugin-form-section-fields-indiv-wrapper-edit-account-button' ).css({'display':'none'});
        });

        $( document ).on( 'click', '#wpplugin-form-section-cancel-edit-existing-user-button-from-dashboard', function( event ) {
            $( '.wpplugin-form-section-fields-indiv-wrapper-actualinput' ).css({'display':'none'});
            $( '.wpplugin-form-section-fields-indiv-wrapper-justtext' ).css({'display':'block'});
            $( '.wpplugin-form-section-fields-indiv-wrapper-edit-account-button' ).css({'display':'block'});
        });
    }


    // Function to toggle between the tabs on the logged-in user's dashboard.
    function wppluginToplevelToggleTabsOnUsersFrontendDashboard(){

        $( document ).on( 'click', '.wpplugin-form-section-wrapper-lefthand-tabs-actual-accountinfo', function( event ) {
            $(this).addClass('wpplugin-form-section-wrapper-lefthand-tabs-actual-active');
            $('.wpplugin-form-section-wrapper-lefthand-tabs-actual-savedposts').removeClass('wpplugin-form-section-wrapper-lefthand-tabs-actual-active');
            $( '.wpplugin-form-section-wrapper-accountinfo' ).css({'display':'block'});
            $( '.wpplugin-form-section-wrapper-savedposts' ).css({'display':'none'});
        });

        $( document ).on( 'click', '.wpplugin-form-section-wrapper-lefthand-tabs-actual-savedposts', function( event ) {
            $(this).addClass('wpplugin-form-section-wrapper-lefthand-tabs-actual-active');
            $('.wpplugin-form-section-wrapper-lefthand-tabs-actual-accountinfo').removeClass('wpplugin-form-section-wrapper-lefthand-tabs-actual-active');
            $( '.wpplugin-form-section-wrapper-accountinfo' ).css({'display':'none'});
            $( '.wpplugin-form-section-wrapper-savedposts' ).css({'display':'block'});
        });
    }
    


    // Function for manually adding a new user from the dashboard. 
    function wppluginToplevelAddNewUser(){

        $( document ).on( 'click', '#wpplugin-not-registered-top-container input, #wpplugin-not-registered-top-container select', function( event ) {
            $( '#wpplugin-not-registered-top-container input' ).css({'color':'inherit'});
        });

        // Binding to trigger checkPasswordStrength
        $( 'body' ).on( 'keyup', 'input[name=password], input[name=password_retyped]',
            function( event ) {
                wppluginToplevelCheckPasswordStrength(
                    $('input[name=password]'),         // First password field
                    $('input[name=password_retyped]'), // Second password field
                    $('#password-strength'),           // Strength meter
                    $('#wpplugin-form-section-add-new-user-button'),           // Submit button
                    ['black', 'listed', 'word']        // Blacklisted words
                );
            }
        );

        
        $( document ).on( 'click', '#wpplugin-form-section-add-new-user-button', function( event ) {

            // Get all the data to add a Student
            var username = $('#wpplugin-user-username').val();
            var password = $('#wpplugin-user-password').val();
            var passwordverify = $('#wpplugin-user-passwordverify').val();
            var firstname = $('#wpplugin-user-firstname').val();
            var lastname = $('#wpplugin-user-lastname').val();
            var contactstreetaddress = $('#wpplugin-user-streetaddress').val();
            var contactcity = $('#wpplugin-user-city').val();
            var contactstate = $('#wpplugin-user-state').val();
            var contactzip = $('#wpplugin-user-zip').val();
            var phonecell = $('#wpplugin-user-cellphone').val();
            var phoneoffice = $('#wpplugin-user-officephone').val();
            var email = $('#wpplugin-user-email').val();
            var userimage1 = $('#wpplugin-user-image1').val();
            var userimage2 = $('#wpplugin-user-image2').val();
            var comments = $('#wpplugin-user-comments').val();

            // Make some checks for required data.
            var proceed_flag = true;
            if ( ( '' === email ) || ( null === email ) || ( undefined === email ) ) {
                proceed_flag = false;
                $('.wpplugin-response-div-p').text( 'Whoops! Looks like you forgot to provide a valid Email address!' );
                return false;
            }

            // Making sure passwords match...
            if ( password !== passwordverify ) {
                proceed_flag = false;
                $('.wpplugin-response-div-p').text( 'Whoops! Looks like your passwords don\'t match!' );
                $( '#wpplugin-user-password, #wpplugin-user-passwordverify' ).css({'color':'red'});
                return false;
            }

            if ( 'Password Strength is...' === $( '#password-strength' ).html() ) {
                proceed_flag = false;
                $('.wpplugin-response-div-p').text( 'Whoops! Looks like you forgot to choose a password!' );
                $( '#wpplugin-user-password, #wpplugin-user-passwordverify' ).css({'color':'red'});
                return false;
            }

            if ( 'Password Strength too low!' === $( '#password-strength' ).html() ) {
                proceed_flag = false;
                $('.wpplugin-response-div-p').text( 'Whoops! Please create a stronger password!' );
                $( '#wpplugin-user-password, #wpplugin-user-passwordverify' ).css({'color':'red'});
                return false;
            }

            if ( proceed_flag ) {

                $('.wpplugin-spinner').animate({'opacity':'1'});

                // Make Ajax call to get display options.
                var data = {
                    'action': 'wpplugintoplevel_add_new_user_action',
                    'security': wppluginToplevelPhpVariables.adminnonce2,
                    'username': username,
                    'password': password,
                    'firstname': firstname,
                    'lastname': lastname,
                    'contactstreetaddress': contactstreetaddress,
                    'contactcity': contactcity,
                    'contactstate': contactstate,
                    'contactzip': contactzip,
                    'phonecell': phonecell,
                    'phoneoffice': phoneoffice,
                    'email': email,
                    'userimage1': userimage1,
                    'userimage2': userimage2,
                    'comments': comments,
                    'location': 'frontend',
                };

                $.post( ajaxurl, data, function( response ) {
                    $('.wpplugin-spinner').animate({'opacity':'0'});

                    // Trying to use an already-registered email address or username.
                    if ( 'Whoops! Looks like someone is already registered with this Email Address!' === response ) {
                        $('.wpplugin-response-div-p').text( response );
                        return false;
                    }else if ( 'Whoops! Looks like this Username is already taken!' === response ) {
                        $('.wpplugin-response-div-p').text( response );
                        return false;
                    } else {
                        $('.wpplugin-response-div-p').text( 'Success! Please wait while we log you in...' );
                        setTimeout(function(){
                            window.location.href = window.location.href + '?un=' + response;
                        }, 5000)
                    }

        
     

                });


            }


        });
    }

});
